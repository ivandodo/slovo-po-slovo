<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–º–µ—Ç–Ω–∏ AI –¢—Ä–µ–Ω–∏–Ω–≥ - –°–ª–æ–≤–æ –ø–æ —Å–ª–æ–≤–æ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --error: #e74c3c; --bg: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1e293b; max-width: 650px; margin: 20px auto; padding: 40px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); border: 1px solid #334155; }
        
        #big-letter { font-size: 10rem; font-weight: bold; color: var(--primary); display: block; height: 160px; line-height: 160px; }
        
        .meter-container { width: 100%; height: 25px; background: #334155; border-radius: 15px; margin: 20px 0; overflow: hidden; position: relative; }
        #confidence-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.5s ease-out; }
        #confidence-text { position: absolute; width: 100%; top: 0; left: 0; line-height: 25px; font-weight: bold; font-size: 0.9rem; }

        .dots-row { margin: 20px 0; }
        .dot { width: 15px; height: 15px; background: #334155; border-radius: 50%; display: inline-block; margin: 0 8px; transition: 0.2s; }
        .dot.active { background: var(--primary); transform: scale(1.4); box-shadow: 0 0 10px var(--primary); }
        .dot.record { background: var(--error); }

        .btn-start { padding: 18px 45px; font-size: 1.4rem; background: var(--success); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-start:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        
        #instruction { font-size: 1.2rem; color: #94a3b8; margin-bottom: 20px; min-height: 1.5em; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; background: #334155; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="setup-screen">
        <h1>–ò–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∏ –¢—Ä–µ–Ω–∏–Ω–≥ üß†</h1>
        <p>–°–∏—Å—Ç–µ–º —õ–µ —Ç—Ä–∞–∂–∏—Ç–∏ –æ–¥ –≤–∞—Å –¥–∞ –ø–æ–Ω–∞–≤—ô–∞—Ç–µ —Å–ª–æ–≤–æ –¥–æ–∫ –Ω–µ –ø–æ—Å—Ç–∏–≥–Ω–µ–º–æ <b>85% —Å–∏–≥—É—Ä–Ω–æ—Å—Ç–∏</b>.</p>
        <button class="btn-start" onclick="startSmartFlow()">–ó–ê–ü–û–ß–ù–ò –¢–†–ï–ù–ò–ù–ì</button>
    </div>

    <div id="training-screen" style="display:none;">
        <div class="status-badge" id="letter-counter">–°–ª–æ–≤–æ: 1/30</div>
        <span id="big-letter">–ê</span>
        <div id="instruction">–ü—Ä–∏–ø—Ä–µ–º–∞...</div>

        <div class="dots-row">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot" id="record-dot"></div>
        </div>

        <div class="meter-container">
            <div id="confidence-bar"></div>
            <div id="confidence-text">–°–∏–≥—É—Ä–Ω–æ—Å—Ç: 0%</div>
        </div>
        <p style="font-size: 0.8rem; color: #64748b;">–¶–∏—ô: 85% —Å–∏–≥—É—Ä–Ω–æ—Å—Ç–∏ –∑–∞ –ø—Ä–µ–ª–∞–∑–∞–∫ –Ω–∞ —Å–ª–µ–¥–µ—õ–µ —Å–ª–æ–≤–æ</p>
    </div>
</div>

<script>
    const azbuka = "–ê–ë–í–ì–î–Ç–ï–ñ–ó–ò–à–ö–õ–â–ú–ù–ä–û–ü–†–°–¢–ã–£–§–•–¶–ß–è–®".split("");
    let transferRecognizer;
    let audioCtx;
    const TARGET_CONFIDENCE = 0.85;

    // Funkcija za zvuƒçni signal
    function playBeep(freq, duration) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration/1000);
        osc.start();
        osc.stop(audioCtx.currentTime + duration/1000);
    }

    async function initAI() {
        const base = speechCommands.create('BROWSER_FFT');
        await base.ensureModelLoaded();
        transferRecognizer = base.createTransfer('smart-azbuka');
    }

    async function startSmartFlow() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('training-screen').style.display = 'block';
        
        // 1. Snimanje ti≈°ine (obavezno za bazu)
        await recordNoise();

        // 2. Prolaz kroz azbuku sa validacijom
        for (let i = 0; i < azbuka.length; i++) {
            document.getElementById('letter-counter').innerText = `–°–ª–æ–≤–æ: ${i+1}/${azbuka.length}`;
            await trainLetterWithValidation(azbuka[i]);
        }

        finishTraining();
    }

    async function recordNoise() {
        document.getElementById('big-letter').innerText = "ü§´";
        document.getElementById('instruction').innerText = "–ë—É–¥–∏—Ç–µ —Ç–∏—Ö–∏... —Å–Ω–∏–º–∞–º –±—É–∫—É";
        for(let i=0; i<8; i++) {
            await transferRecognizer.collectExample('_background_noise_');
            await new Promise(r => setTimeout(r, 300));
        }
    }

    async function trainLetterWithValidation(slovo) {
        document.getElementById('big-letter').innerText = slovo;
        let currentConfidence = 0;
        let samplesCollected = 0;

        while (currentConfidence < TARGET_CONFIDENCE || samplesCollected < 3) {
            // Ritam bipa
            const dots = document.querySelectorAll('.dot');
            for (let b = 0; b < 3; b++) {
                dots[b].classList.add('active');
                playBeep(440, 100);
                document.getElementById('instruction').innerText = "–ü—Ä–∏–ø—Ä–µ–º–∞...";
                await new Promise(r => setTimeout(r, 500));
                dots[b].classList.remove('active');
            }

            // Snimanje
            dots[3].classList.add('record');
            playBeep(880, 150);
            document.getElementById('instruction').innerText = "–ò–ó–ì–û–í–û–†–ò –°–ê–î!";
            await transferRecognizer.collectExample(slovo);
            samplesCollected++;
            
            dots[3].classList.remove('record');
            document.getElementById('instruction').innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º...";

            // Kratki trening "u letu" da dobijemo procenat (brzinski 10 epoha)
            await transferRecognizer.train({ epochs: 10, showProgress: false });
            
            // Provera trenutne sigurnosti
            const result = await transferRecognizer.recognize();
            const idx = result.scores.indexOf(Math.max(...result.scores));
            const recognizedLabel = transferRecognizer.wordLabels()[idx];
            
            if (recognizedLabel === slovo) {
                currentConfidence = result.scores[idx];
            } else {
                currentConfidence = 0; // Proma≈°io je slovo
            }

            // Update UI
            updateMeter(currentConfidence);
            
            if (currentConfidence < TARGET_CONFIDENCE) {
                document.getElementById('instruction').innerText = "–ù–∏—Å–∫–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç. –ü–æ–∫—É—à–∞—ò–º–æ –ø–æ–Ω–æ–≤–æ...";
                await new Promise(r => setTimeout(r, 1000));
            } else {
                document.getElementById('instruction').innerText = "–û–¥–ª–∏—á–Ω–æ! –ü—Ä–µ–ª–∞–∑–∏–º–æ –¥–∞—ô–µ.";
                await new Promise(r => setTimeout(r, 800));
            }
        }
    }

    function updateMeter(val) {
        const percent = Math.round(val * 100);
        const bar = document.getElementById('confidence-bar');
        bar.style.width = percent + "%";
        document.getElementById('confidence-text').innerText = `–°–∏–≥—É—Ä–Ω–æ—Å—Ç: ${percent}%`;
        
        if (percent >= 85) bar.style.background = "#2ecc71";
        else if (percent >= 50) bar.style.background = "#f1c40f";
        else bar.style.background = "#e74c3c";
    }

    async function finishTraining() {
        document.getElementById('instruction').innerText = "–§–∏–Ω–∞–ª–Ω–æ –ø–æ–¥–µ—à–∞–≤–∞—ö–µ –º—Ä–µ–∂–µ...";
        await transferRecognizer.train({ epochs: 30 });
        await transferRecognizer.save('indexeddb://pametni-model-azbuka');
        document.getElementById('big-letter').innerText = "‚úÖ";
        document.getElementById('instruction').innerHTML = "<a href='index.html' style='color:white; font-size:1.5rem; text-decoration:none;'>üöÄ –ö–†–ï–ù–ò –ù–ê –ò–ì–†–£</a>";
    }

    initAI();
</script>
</body>
</html>