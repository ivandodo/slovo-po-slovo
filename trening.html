<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <title>AI Trening - Slovo po slovo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@latest/dist/speech-commands.min.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --bg: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1e293b; max-width: 600px; margin: 40px auto; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        #big-letter { font-size: 10rem; font-weight: bold; color: var(--primary); display: block; height: 160px; line-height: 160px; margin-bottom: 20px; }
        .timer-dot { width: 20px; height: 20px; background: #334155; border-radius: 50%; display: inline-block; margin: 5px; transition: 0.2s; }
        .active-dot { background: var(--success); transform: scale(1.3); }
        .btn-start { padding: 20px 40px; font-size: 1.5rem; background: var(--success); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .progress-container { width: 100%; background: #334155; height: 8px; border-radius: 4px; margin-top: 30px; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); transition: 0.3s; }
        #status { margin-top: 15px; color: #94a3b8; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="card">
    <div id="setup">
        <h1>Ritmiƒçki Trening üéß</h1>
        <p>Prati zvuk "bipa". Na ƒçetvrti (vi≈°i) zvuk izgovori slovo jasno i kratko.</p>
        <button class="btn-start" onclick="startTrainingFlow()">ZAPOƒåNI TRENING</button>
    </div>

    <div id="training" style="display:none;">
        <span id="big-letter">?</span>
        <div id="dots">
            <div class="timer-dot"></div>
            <div class="timer-dot"></div>
            <div class="timer-dot"></div>
            <div class="timer-dot"></div>
        </div>
        <div id="status">Priprema...</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
    </div>
</div>

<script>
    const azbuka = "–ê–ë–í–ì–î–Ç–ï≈Ω–ó–ò–à–ö–õ–â–ú–ù–ä–û–ü–†–°–¢–ã–£–§–•–¶–ß–è≈†".split(""); // Miks zbog lak≈°eg prepoznavanja
    let transferRecognizer;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Funkcija za generisanje Bipa
    function playBeep(freq, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.type = "sine";
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration/1000);
        osc.start();
        osc.stop(audioCtx.currentTime + duration/1000);
    }

    async function init() {
        const base = speechCommands.create('BROWSER_FFT');
        await base.ensureModelLoaded();
        transferRecognizer = base.createTransfer('brzi-model');
    }

    async function startTrainingFlow() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('training').style.display = 'block';
        
        // 1. Snimanje ti≈°ine
        await recordNoise();

        // 2. Snimanje azbuke
        for (let i = 0; i < azbuka.length; i++) {
            await trainLetter(azbuka[i]);
            document.getElementById('progress-bar').style.width = ((i+1)/azbuka.length*100) + "%";
        }

        finish();
    }

    async function recordNoise() {
        document.getElementById('big-letter').innerText = "ü§´";
        document.getElementById('status').innerText = "Budi tiho - snimam pozadinu...";
        for(let i=0; i<6; i++) {
            await transferRecognizer.collectExample('_background_noise_');
            await new Promise(r => setTimeout(r, 400));
        }
    }

    async function trainLetter(slovo) {
        document.getElementById('big-letter').innerText = slovo;
        const dots = document.querySelectorAll('.timer-dot');
        
        // Snimamo 4 uzorka po slovu u ritmu
        for (let sample = 0; sample < 4; sample++) {
            // Ritam: bip, bip, bip, BEEP (izgovori)
            for (let b = 0; b < 3; b++) {
                dots[b].classList.add('active-dot');
                playBeep(440, 100); // Ni≈æi ton
                await new Promise(r => setTimeout(r, 500));
                dots[b].classList.remove('active-dot');
            }
            
            // Finalni ton za snimanje
            dots[3].classList.add('active-dot');
            playBeep(880, 150); // Vi≈°i ton
            document.getElementById('status').innerText = "SAD!";
            
            // Snimanje slova
            await transferRecognizer.collectExample(slovo);
            
            await new Promise(r => setTimeout(r, 400));
            dots[3].classList.remove('active-dot');
            document.getElementById('status').innerText = "Odliƒçno...";
        }
    }

    async function finish() {
        document.getElementById('status').innerText = "Treniram neuronsku mre≈æu...";
        await transferRecognizer.train({ epochs: 50 });
        await transferRecognizer.save('indexeddb://moj-model-slova');
        document.getElementById('big-letter').innerText = "‚úÖ";
        document.getElementById('status').innerHTML = "<a href='index.html' style='color:white; font-size:1.5rem;'>KRENI NA IGRU</a>";
    }

    init();
</script>
</body>
</html>